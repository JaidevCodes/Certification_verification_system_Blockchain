<!DOCTYPE html>
<html>
<head>
    <title>Blockchain Certificate Verifier</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .container { border: 1px solid #ccc; padding: 20px; border-radius: 10px; }
        input, button { padding: 10px; margin: 10px 0; width: 100%; box-sizing: border-box; }
        .result { margin-top: 20px; padding: 15px; border-radius: 5px; }
        .valid { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .invalid { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Blockchain Certificate Verifier</h1>
        <input type="text" id="certificateId" placeholder="Enter Certificate ID (e.g., CERT-001)">
        <button onclick="verifyCertificate()">Verify Certificate</button>
        <div id="result" class="result">Ready to verify certificates...</div>
    </div>

    <script>
        // Multiple reliable RPC endpoints for Polygon Amoy
        const RPC_URLS = [
            "https://polygon-amoy-bor.publicnode.com",
            "https://rpc.ankr.com/polygon_amoy",
            "https://polygon-amoy.gateway.tenderly.co",
            "https://matic-mumbai.chainstacklabs.com" // Mumbai fallback (compatible)
        ];

        // Your contract details
        const contractAddress = "0x862d6798Cf35823b565342804e3F474686372720";
        const contractABI = [
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "certId",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "studentName",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "courseName",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "ipfsHash",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "issueDate",
				"type": "uint256"
			}
		],
		"name": "CertificateIssued",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "certId",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "studentName",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "courseName",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "issuer",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "ipfsHash",
				"type": "string"
			}
		],
		"name": "issueCertificate",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "certificates",
		"outputs": [
			{
				"internalType": "string",
				"name": "studentName",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "courseName",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "issuer",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "ipfsHash",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "issueDate",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "certId",
				"type": "string"
			}
		],
		"name": "verifyCertificate",
		"outputs": [
			{
				"internalType": "string",
				"name": "studentName",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "courseName",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "issuer",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "ipfsHash",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "issueDate",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

        async function tryRPCConnection() {
            for (const rpcUrl of RPC_URLS) {
                try {
                    const provider = new ethers.providers.JsonRpcProvider(rpcUrl);
                    // Test connection with a simple call
                    await provider.getNetwork();
                    console.log("Connected to:", rpcUrl);
                    return provider;
                } catch (error) {
                    console.log("Failed to connect to:", rpcUrl, error.message);
                    continue;
                }
            }
            throw new Error("Could not connect to any Polygon Amoy RPC endpoint");
        }
        
        async function verifyCertificate() {
            const certificateId = document.getElementById('certificateId').value;
            const resultDiv = document.getElementById('result');
            
            if (typeof ethers === 'undefined') {
                resultDiv.className = "result invalid";
                resultDiv.innerHTML = "Ethers.js library not loaded. Please refresh.";
                return;
            }
            
            if (!certificateId) {
                resultDiv.className = "result invalid";
                resultDiv.innerHTML = "Please enter a Certificate ID";
                return;
            }
            
            resultDiv.className = "result loading";
            resultDiv.innerHTML = "‚è≥ Connecting to blockchain...";
            
            try {
                // Try to connect to any working RPC
                const provider = await tryRPCConnection();
                const contract = new ethers.Contract(contractAddress, contractABI, provider);
                
                resultDiv.innerHTML = "‚è≥ Checking certificate...";
                
                // Check certificate using the mapping directly
                const certData = await contract.certificates(certificateId);
                
                if (certData.ipfsHash && certData.ipfsHash.length > 0) {
                    resultDiv.className = "result valid";
                    resultDiv.innerHTML = `
                        <h3>‚úÖ Valid Certificate</h3>
                        <p><strong>Student:</strong> ${certData.studentName}</p>
                        <p><strong>Course:</strong> ${certData.courseName}</p>
                        <p><strong>Issuer:</strong> ${certData.issuer}</p>
                        <p><strong>Issued on:</strong> ${new Date(certData.issueDate * 1000).toLocaleDateString()}</p>
                        <p><a href="https://ipfs.io/ipfs/${certData.ipfsHash}" target="_blank">View Certificate File</a></p>
                    `;
                } else {
                    resultDiv.className = "result invalid";
                    resultDiv.innerHTML = "‚ùå Certificate not found";
                }
            } catch (error) {
                resultDiv.className = "result invalid";
                resultDiv.innerHTML = `
                    Error: ${error.message}<br><br>
                    <strong>Troubleshooting steps:</strong>
                    <ol>
                        <li>Check your internet connection</li>
                        <li>Refresh the page and try again</li>
                        <li>Try a different browser</li>
                    </ol>
                `;
                console.error("Full error:", error);
            }
        }

        // Check if ethers is loaded on page load
        if (typeof ethers !== 'undefined') {
            document.getElementById('result').innerHTML = "‚úÖ Library loaded. Ready to verify!";
        }
    </script>
</body>
</html>